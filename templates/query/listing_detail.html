{% extends "index.html" %}
{% block mainContent %}
{% load staticfiles %}
{% load comments %}
        <div id="breadcrumb">
            <span>Category: <a href="#">Category Parent</a> &gt <a href="#">Photography</a></span>
        </div>
        {% include "query/listing_header.html" %}
        <div class="app_feature">
            <div class="feature_block">
                <ul class="feature_list">
                    <li><span class="li_title">Rating and Reviews</span></li>
                    <li><span>Rating:</span><span class="right margin_right_20" >{{ app.rating }}</span></li>
                    <li><span>Reviews:</span><span class="right margin_right_20" >{{ app.reviews|default:0 }}</span></li>

                </ul>
            </div>
            <div class="feature_block">
                <ul class="feature_list">
                    <li><span class="li_title">Price</span></li>
                    <li><span>Price in App Store:</span><span class="right margin_right_20" >{{ appInfo.price|floatformat|default:0 }}{{ app.currency.currency }}</span></li>

                </ul>
            </div>
            <div class="feature_block">
                <ul class="feature_list">
                    <li><span class="li_title">Other Stats </span></li>
                    <li><span>Last Updated:</span><span class="right margin_right_20" >{{ app.last_modify|date:"jS M, Y" }}</span></li>
                    <li><span>App Support Link:</span><span class="right margin_right_20" >
                        {% if app.web_site %}<a target="_blank" href="{{ app.web_site }}">Support site</a>{% else %}No support site{% endif %}
                    </span></li>
                </ul>
            </div>
        </div>
        <div class="hint_block">

        </div>
        <div class="separator"></div>
        <div class="listing_detail">
            <div class="detail_left">
                <div class="detail_title"><h1>Description</h1></div>
                {% autoescape off %}
                {{ app.description }}
                {% endautoescape %}

                <div class="comments_wrapper">
                    {% if comment_list %}
                    <div style="margin-bottom: 10px;"><h1>Comments and Questions:</h1></div>
                    {% endif %}
                    {% get_comment_list for app as comment_list %}
                    {% for comment in comment_list %}
                        {% ifequal comment.user_name request.user.username %}
                        <div class="comments_red">
                        {% else %}
                         <div class="comments">
                        {% endifequal %}
                        <div class="comment_header"> <span><img src=""/></span>on {{ comment.submit_date|date:" M j, Y" }} at {{ comment.submit_date|time:"g:iA"|lower }}, {{ comment.user_name }} said: </div>
                        <p>{{ comment.comment|safe }}</p>
                        {% if comment.user_name != request.user.username %}
                        <span style="float: right"><a id="reply" href="#new_comment" onclick="reply('{{ comment.user_name }}')">Reply</a></span>
                        {% endif %}
                        </div>

                    {%endfor%}
                    </div>

                <div id="new_comment" class="comments_form">
                    <h1>Leave a Comment</h1>
                     {% if user.is_authenticated %}
                    <p class="form-allowed-tags">You may use these <abbr title="HyperText Markup Language">HTML</abbr> tags and attributes:  <code>&lt;a href="" title=""&gt; &lt;abbr title=""&gt; &lt;acronym title=""&gt; &lt;b&gt; &lt;blockquote cite=""&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=""&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=""&gt; &lt;strike&gt; &lt;strong&gt; </code></p>

                    {% get_comment_form for app as form %}
                    <table>
                        <form action="{% comment_form_target %}" method="post">
                            {% csrf_token %}
                            <input id="id_honeypot" name="honeypot" hidden="hidden" type="text" />
{#                            {{ form.honeypot }}#}
                            {{ form.content_type }}
                            {{ form.object_pk }}
                            {{ form.timestamp }}
                            {{ form.security_hash }}
                            <input id="id_email" name="email" type="text" hidden="hidden" value="{{ user.email }}" />
                            {{ form.comment }}
                            <tr>
                                <td>
                                    <div class='errors_block'></div>
                                    <input type="hidden" name="next" value="{% url 'query:app_detail' app.id %}" />
                                    <input class="nextbutton" type="submit" id="id_submit" name="submit" value="Add comment">
                                </td>
                            </tr>
                        </form>
                    </table>
                    {% else %}
                        <p>Please <a href="/usersetting/home/?next={{ request.path }}">log in</a> to leave a comment.</p>
                    {% endif %}
                </div>
             </div>
            <div class="detail_right">
                <div class="widget">
                   <span class="widget_title">Seller</span>
                   <ul>
                       <li><span>{{ app.seller_name }}</span>
                           {% if app.publisher.username != request.user.username %}
                           <span><a href="/dashboard/create-message/reply/{{ app.publisher.username }}/{{ app.publisher.id }}?next={{ request.path }}">
                               <b>Send Message</b><!--TODO:It is better to use image.-->
                           </a></span>
                           {% endif %}
                       </li>
                   </ul>

                </div>
                <div class="widget">
                   <span class="widget_title">Claimed App Age</span>
                   <ul>
                       <li><span>App Established</span><span class="right">{{ appInfo.release_date|date:"jS M, Y" }}</span></li>
                   </ul>

                </div>
                <div class="widget">
                   <span class="widget_title">Claimed Downloads</span>
                   <ul>
                       <li><span> Downloads(monthly avg)</span><span class="right">{{ app.dl_amount|default:0 }}</span></li>
                   </ul>

                </div>
                <div class="widget">
                   <span class="widget_title">Claimed Financials</span>
                   <ul>
                       <li><span>Revenue</span><span class="right">{{ app.revenue|floatformat|default:0 }}{{ app.currency.currency }}</span></li>
{#                       <li><span>Profit</span><span class="right">5,00${{ profit }}</span></li>#}
                   </ul>

                </div>
                <div class="widget">
                   <span class="widget_title">Monetization Methods</span>
                   <ul>
                       {% for monetize in all_monetizes %}
                       <li><span>{{ monetize.method }}</span>
                           {% if monetize in cur_monetizes %}
                               <span class="right">YES</span>
                           {% endif %}
                       </li>
                       {% endfor %}
                   </ul>

                </div>
                {% if attachments %}
                <div class="widget">
                   <span class="widget_title">Attachments</span>
                   <ul>
                       {% for attachment in attachments %}
                       <li class="document_icon"><a target="_blank" href="{{ attachment.path.url }}">{{ attachment.name }}</a></li>
                       {% endfor %}
                   </ul>
                </div>
                {% endif %}
                <div class="widget">
                   <span class="widget_title">Category </span>
                   <ul>
                       {% for category, sub_list in category_map.items %}
                           <!--Category start-->
                           <li>
                               <span><a href="/query/featured?category={{ category.apple_id }}">{{ category.name }}({{ sub_list.0 }})</a></span>
                           </li>
                           <!--Category end-->

                           <!--SubCategory start-->
                           {% if sub_list|length > 1 %}
                               <li>
                                   <ul>
                                   {% for subcategory in sub_list %}
                                       {% if forloop.counter > 1 %}
                                           <li>
                                               <span><a href="/query/featured?subcategory={{ subcategory.0.apple_id }}">{{ subcategory.0.name }}({{ subcategory.1 }})</a></span>
                                           </li>
                                       {% endif %}
                                   {% endfor %}
                                   </ul>
                               </li>
                           {% endif %}
                           <!--SubCategory end-->
                       {% endfor %}
                   </ul>
                </div>

            </div>
            <div class="clear"></div>
        </div>

<script type="text/javascript" language="javascript">
    $("#id_submit").click(function() {
        if ($("#id_comment").val() == "") {
            $(".errors_block").html("<ul><li>Comment can not be blank.</li></ul>");//TODO:it will be set in message.properties.
            return false;
        }
    });
    function reply(username) {
        $("#id_comment").text("@"+username+" ");
    }
</script>
{% endblock %}